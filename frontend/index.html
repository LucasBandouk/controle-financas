<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Controle de Finanças</title>
</head>
<body>
    <h1>Login</h1>
    <input id="username" placeholder="Usuário" />
    <input id="senha" type="password" placeholder="Senha" />
    <button onclick="login()">Entrar</button>

    <div id="app" style="display:none;">
        <button onclick="logout()" style="float:right;">Logout</button>
        <h2>Nova Transação</h2>
        <input id="valor" type="number" step="0.01" placeholder="Valor" />
        <input id="descricao" placeholder="Descrição" />
        <select id="tipo">
            <option value="receita">Receita</option>
            <option value="despesa">Despesa</option>
        </select>
        <button onclick="addTransacao()">Adicionar</button>

        <h2>Transações</h2>
        <ul id="lista"></ul>
    </div>

    <script>
        const API = "http://127.0.0.1:5000";

        // Ao carregar a página, verifica se há usuário logado
        window.onload = () => {
            const usuarioSalvo = localStorage.getItem("usuario_id");
            if (usuarioSalvo) {
                usuario_id = usuarioSalvo;
                document.getElementById("app").style.display = "block";
                carregarTransacoes();
            }
        }

        let usuario_id = null;

        async function login() {
            const username = document.getElementById("username").value;
            const senha = document.getElementById("senha").value;
            const res = await fetch(API + "/login", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({username, senha})
            });
            if (res.ok) {
                const data = await res.json();
                usuario_id = data.usuario_id;
                // Salva no LocalStorage
                localStorage.setItem("usuario_id", usuario_id);
                document.getElementById("app").style.display = "block";
                carregarTransacoes();
            } else {
                alert("Login falhou");
            }
        }

        async function addTransacao() {
            const valor = parseFloat(document.getElementById("valor").value);
            const descricao = document.getElementById("descricao").value;
            const tipo = document.getElementById("tipo").value;
            await fetch(API + "/transacoes", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({valor, descricao, tipo, usuario_id})
            });
            carregarTransacoes();
        }

        async function carregarTransacoes() {
            const res = await fetch(API + "/transacoes/" + usuario_id);
            const lista = await res.json();
            const ul = document.getElementById("lista");
            ul.innerHTML = "";
            lista.forEach(t => {
                const li = document.createElement("li");
                li.textContent = `${t.tipo.toUpperCase()} - R$${t.valor} (${t.descricao})`;
                ul.appendChild(li);
            });
        }

        function logout() {
            // Limpa LocalStorage
            localStorage.removeItem("usuario_id");
            usuario_id = null;
            document.getElementById("app").style.display = "none";
            document.getElementById("username").value = "";
            document.getElementById("senha").value = "";
        }
    </script>
</body>
</html>
