<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Controle de Finanças</title>
</head>
<body>
    <h1>Login</h1>
    <input id="username" placeholder="Usuário" />
    <input id="senha" type="password" placeholder="Senha" />
    <button onclick="login()">Entrar</button>

    <div id="app" style="display:none;">
        <button onclick="logout()" style="float:right;">Logout</button>

        <h2>Resumo Financeiro</h2>
        <div id="resumo">
            <p><strong>Total de Receitas:</strong> R$<span id="receitas">0.00</span></p>
            <p><strong>Total de Despesas:</strong> R$<span id="despesas">0.00</span></p>
            <p><strong>Saldo:</strong> R$<span id="saldo">0.00</span></p>
        </div>

        <h2>Criar Categoria</h2>
        <input id="novaCategoria" placeholder="Nome da Categoria" />
        <button onclick="addCategoria()">Adicionar Categoria</button>

        <h2>Nova Transação</h2>
        <input id="valor" type="number" step="0.01" placeholder="Valor" />
        <input id="descricao" placeholder="Descrição" />
        <select id="tipo">
            <option value="receita">Receita</option>
            <option value="despesa">Despesa</option>
        </select>
        <select id="categoriaSelect">
            <option value="">Sem categoria</option>
        </select>
        <button onclick="addTransacao()">Adicionar</button>

        <h2>Filtrar Transações</h2>
        <select id="filtroCategoria" onchange="filtrarTransacoes()">
            <option value="">Todas</option>
        </select>

        <h2>Transações</h2>
        <ul id="lista"></ul>
    </div>

    <script>
        const API = "http://127.0.0.1:5000";
        let usuario_id = null;

        window.onload = () => {
            const usuarioSalvo = localStorage.getItem("usuario_id");
            if (usuarioSalvo) {
                usuario_id = usuarioSalvo;
                document.getElementById("app").style.display = "block";
                carregarCategorias();
                carregarTransacoes();
                carregarResumo();
            }
        }

        async function login() {
            const username = document.getElementById("username").value;
            const senha = document.getElementById("senha").value;
            const res = await fetch(API + "/login", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({username, senha})
            });
            if (res.ok) {
                const data = await res.json();
                usuario_id = data.usuario_id;
                localStorage.setItem("usuario_id", usuario_id);
                document.getElementById("app").style.display = "block";
                carregarCategorias();
                carregarTransacoes();
                carregarResumo();
            } else {
                alert("Login falhou");
            }
        }

        function logout() {
            localStorage.removeItem("usuario_id");
            usuario_id = null;
            document.getElementById("app").style.display = "none";
            document.getElementById("username").value = "";
            document.getElementById("senha").value = "";
        }

        async function addCategoria() {
            const nome = document.getElementById("novaCategoria").value;
            if (!nome) return alert("Digite o nome da categoria");
            await fetch(API + "/categorias", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({nome, usuario_id})
            });
            document.getElementById("novaCategoria").value = "";
            carregarCategorias();
        }

        async function carregarCategorias() {
            const res = await fetch(API + "/categorias/" + usuario_id);
            const categorias = await res.json();

            const select = document.getElementById("categoriaSelect");
            select.innerHTML = '<option value="">Sem categoria</option>';
            categorias.forEach(cat => {
                const option = document.createElement("option");
                option.value = cat.id;
                option.textContent = cat.nome;
                select.appendChild(option);
            });

            const filtro = document.getElementById("filtroCategoria");
            filtro.innerHTML = '<option value="">Todas</option>';
            categorias.forEach(cat => {
                const option = document.createElement("option");
                option.value = cat.id;
                option.textContent = cat.nome;
                filtro.appendChild(option);
            });
        }

        async function addTransacao() {
            const valor = parseFloat(document.getElementById("valor").value);
            const descricao = document.getElementById("descricao").value;
            const tipo = document.getElementById("tipo").value;
            const categoria_id = document.getElementById("categoriaSelect").value || null;

            await fetch(API + "/transacoes", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({valor, descricao, tipo, usuario_id, categoria_id})
            });

            document.getElementById("valor").value = "";
            document.getElementById("descricao").value = "";
            document.getElementById("categoriaSelect").value = "";
            carregarTransacoes();
            carregarResumo();
        }

        async function carregarTransacoes() {
            const res = await fetch(API + "/transacoes/" + usuario_id);
            const lista = await res.json();
            const ul = document.getElementById("lista");
            ul.innerHTML = "";
            lista.forEach(t => {
                const li = document.createElement("li");
                li.textContent = `${t.tipo.toUpperCase()} - R$${t.valor} (${t.descricao})` +
                                 (t.categoria ? ` - Categoria: ${t.categoria}` : "");
                ul.appendChild(li);
            });
        }

        async function filtrarTransacoes() {
            const categoria_id = document.getElementById("filtroCategoria").value;
            let url = API + "/transacoes/" + usuario_id;
            if (categoria_id) url += "/categoria/" + categoria_id;

            const res = await fetch(url);
            const lista = await res.json();
            const ul = document.getElementById("lista");
            ul.innerHTML = "";
            lista.forEach(t => {
                const li = document.createElement("li");
                li.textContent = `${t.tipo.toUpperCase()} - R$${t.valor} (${t.descricao})` +
                                 (t.categoria ? ` - Categoria: ${t.categoria}` : "");
                ul.appendChild(li);
            });
        }

        async function carregarResumo() {
            const res = await fetch(API + "/resumo/" + usuario_id);
            const data = await res.json();

            document.getElementById("receitas").textContent = data.total_receitas.toFixed(2);
            document.getElementById("despesas").textContent = data.total_despesas.toFixed(2);
            document.getElementById("saldo").textContent = data.saldo.toFixed(2);

            const saldoSpan = document.getElementById("saldo");
            saldoSpan.style.color = data.saldo >= 0 ? "green" : "red";
        }
    </script>
</body>
</html>